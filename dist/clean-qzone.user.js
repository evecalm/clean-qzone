// ==UserScript==
// @name           Clean Qzone
// @namespace      com.saiya.clean-qzone
// @author         Saiya
// @description    Remove all Qzone ads, make your Qzone center clean and clear.
// @match          *://*.qzone.qq.com/*
// @include        *://*.qzone.qq.com/*
// @updateURL      http://app.evecalm.com/clean-qzone/dist/clean-qzone.meta.js
// @downloadURL    http://app.evecalm.com/clean-qzone/dist/clean-qzone.user.js
// @version        0.1.12
// ==/UserScript==
// source code: https://github.com/evecalm/clean-qzone
function proxy(a){var b=document.createElement("script");b.textContent="("+a.toString()+")(window);",document.body.appendChild(b)}function main(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};i=function(a,b,c){var d;return d=null,(isNaN(c)||c<0)&&(c=200),isNaN(b)||(b>0&&(c=b),b=void 0),function(){clearTimeout(d),d=setTimeout(function(){null!=a&&a.call(b)},c)}},R=function(a,b,c){var d,e;return d=!1,e=null,(isNaN(c)||c<0)&&(c=200),isNaN(b)||(b>0&&(c=+b),b=void 0),function(){var f,g;f=+new Date,!1===d&&(d=f),g=c-(f-d),clearTimeout(e),g<=0?(null!=a&&a.call(b),c=!1):e=setTimeout(function(){null!=a&&a.call(b)},g)}},m=function(a,b){for(;a;){if(a.classList.contains(b))return a;a=a.parentElement}},J=function(a){return!(!a||!a.parentElement)&&(a.parentElement.removeChild(a),!0)},l=function(a){return String(a).replace(/&/g,"&amp;".replace(/</g,"&lt;".replace(/>/g,"&gt;".replace(/"/g,"&quot;"))))},t={_storeKey:"isa-cq-settings",kwdsKey:"kwds",bgimgsKey:"bgimg-list",set:function(a,b){return this._data[a]=b,this.save()},get:function(a){return this._data[a]},save:function(){return localStorage.setItem(this._storeKey,JSON.stringify(this._data))},getKwds:function(){var a;return a=this.get(this.kwdsKey),null==a&&(a=[]),a},addKwd:function(a){var b;return b=this.getKwds(),!(W.call(b,a)>=0)&&(b.unshift(a),this.set(this.kwdsKey,b),!0)},removeKwd:function(a){var b,c;return c=this.getKwds(),!!~(b=c.indexOf(a))&&(c.splice(b,1),this.set(this.kwdsKey,c),!0)},getBgimgs:function(){var a;return a=this.get(this.bgimgsKey),null==a&&(a=[]),a},removeBgimg:function(a){var b,c;return b=this.getBgimgs(),!!~(c=b.indexOf(a))&&(b.splice(c,1),this.set(this.bgimgsKey,b),!0)},addBgimg:function(a){var b;return b=this.getBgimgs(),!(W.call(b,a)>=0)&&(b.unshift(a),this.set(this.bgimgsKey,b),!0)}},t._data=function(){var a;return a=localStorage.getItem(t._storeKey),JSON.parse(a||"{}")}(),q=function(){var a,b;b="isa-qzone-style",document.getElementById(b)||(a=document.createElement("style"),a.id=b,a.setAttribute("type","text/css"),a.textContent=".cq-hide{display:none !important}.cq-yosemite-style-bg{-webkit-filter:blur(6px) saturate(2);background-size:cover}.cq-disabled{opacity:.6;cursor:default;pointer-events:none}.cq-input{border:1px solid #bfbfbf;border-radius:2px;box-sizing:border-box;color:#444;font:inherit;margin:0;padding:2px 6px;outline:none}.cq-input:focus{outline:none}.cq-btn{border:1px solid #cfcfcf;background:none;color:#666;text-align:center;border-radius:3px;line-height:26px;box-sizing:border-box;-webkit-appearance:none;-moz-appearance:none;appearance:none;padding:0 10px;margin:0;height:28px;white-space:nowrap;position:relative;overflow:hidden;text-overflow:ellipsis;font-size:14px;font-family:inherit;cursor:pointer;outline:none}.cq-btn:active{text-decoration:none;background:#f5f5f5}[data-url^=\"http://c.gdt.qq.com\"],.gdtads_box,.ck-act,.icenter-right-ad,.fn_paipai,.mod-side-nav-recently-used,.hot-msg,.msg-channel-wrapper,.user-vip-info,.gb_ad_tearing_angle,.icon_app_new,.fn_accessLog_tips,.qz-app-flag,.icon-new-fun,.hotbar_wrap,.icon-red-dot,.sn-radio,.user-home,.mall-sp-container,#js-qq-ad{display:none !important}.cq-remove-qzvip .vip-setting,.cq-remove-qzvip .qz-f-vip-l-y,.cq-remove-qzvip .qz-f-vip-l,.cq-remove-qzvip .detail-info-level,.cq-remove-qzvip #divGif4Visitor{display:none !important}.cq-fixed-sidebar{position:fixed;width:170px;top:41px}.cq-fullwidth{transition:width .3s linear;width:100% !important}.cq-fullwidth .img-box-row-wrap .img-box-row{display:inline !important}.cq-fullwidth .img-box-row-wrap .img-box-row+.img-box-row{margin-left:4px}.top-fix-inner{z-index:1010 !important}.cq-bg{display:none;transition:all .5s ease-out}.cq-yosemite .cq-bg{display:block;position:fixed;top:0;bottom:0;right:0;left:0;-webkit-filter:blur(6px) saturate(2);background-size:cover}.cq-yosemite .background-container{position:relative;background:none}.cq-yosemite .mod-side-nav{box-shadow:0 0 1px rgba(0,0,0,0.07);background-color:#f9f9f9;border:1px solid #e9e9e9}.cq-overlay{display:none;position:fixed;top:0;left:0;bottom:0;right:0;background-color:rgba(0,0,0,0.3);z-index:99999}.cq-show-setting-dlg{overflow:hidden !important}.cq-show-setting-dlg .cq-overlay{display:block}.cq-settings-dialog{position:absolute;top:0;left:0;bottom:0;right:0;height:60%;width:60%;min-width:600px;max-width:700px;margin:auto;overflow:hidden;border:1px solid rgba(0,0,0,0.1);background-color:#f9f9f9;box-shadow:0 0 1px rgba(0,0,0,0.07);color:#333;border-radius:6px;font:14px/1.6 Tahoma,Geneva,'Simsun';box-sizing:border-box}.cq-sidemenu{position:absolute;left:0;top:0;width:20%;height:100%}.cq-sidemenu .title{padding:10px 6px;color:#08c;font-weight:bold;text-align:center}.cq-sidemenu .cq-menus{list-style:none;padding:0;margin:0;color:#999}.cq-sidemenu .cq-menus>li{box-sizing:border-box;padding:4px 8px;border-left:4px solid transparent;cursor:pointer}.cq-sidemenu .cq-menus>li.active{color:#666;border-left-color:#999;cursor:default;pointer-events:none}.cq-settings-close{position:absolute;top:6px;right:6px;width:2em;height:2em}.cq-settings-close:after,.cq-settings-close:before{position:absolute;left:9px;content:' ';width:3px;height:100%;background-color:#ccc;transition:all .2s linear}.cq-settings-close:after{-webkit-transform:rotate(45deg);transform:rotate(45deg)}.cq-settings-close:before{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}.cq-settings-close:hover:after,.cq-settings-close:hover:before{background-color:#555}.cq-setting-wrapper{width:80%;margin-left:20%;padding:8px 14px 8px 0;box-sizing:border-box;height:100%;overflow:hidden;overflow-y:auto}.cq-setting-content{display:none}.cq-setting-content.active{display:block}.cq-setting-content .title{font-size:1.2em;padding:8px;border-bottom:1px solid #ccc;margin-bottom:10px}.cq-setting-content .title>small{color:#777;font-size:.8em;margin-left:8px}.cq-input-wrapper{margin-bottom:10px}.cq-kwds{list-style:none;padding:0;margin:0;color:#888;font-size:.8em}.cq-kwds>li{display:inline-block;margin-right:4px;border:1px solid #ddd;padding:3px 12px;border-radius:16px;margin-bottom:6px;cursor:default}.cq-kwds>li>.close{margin-left:2px;font-size:1.2em;cursor:pointer}.cq-kwds>li>.close:after{content:'×'}.cq-kwds>li:hover{box-shadow:0 2px 2px #ccc}.cq-kwds>li:hover>.close{color:#333}#cq-theme-choose-wrapper{margin-top:8px;opacity:.6;cursor:default;pointer-events:none;transition:opacity .2s ease-in}#cq-theme-ckbx:checked~#cq-theme-choose-wrapper{opacity:1;cursor:auto;pointer-events:auto}#cq-theme-ckbx:checked~#cq-theme-choose-wrapper .cq-close{display:block}.cq-themes{list-style:none;padding:0;margin:0}.cq-themes>li{position:relative;display:inline-block;margin-right:1em;border-radius:6px;border:1px solid #ddd;width:46%;padding-bottom:23%;margin-bottom:6px;cursor:pointer;vertical-align:middle;overflow:hidden}.cq-themes>li>.cq-close{font-size:.6em;display:none;position:absolute;top:6px;right:6px;width:2em;height:2em;z-index:2}.cq-themes>li>.cq-close:after,.cq-themes>li>.cq-close:before{position:absolute;left:9px;content:' ';width:3px;height:100%;background-color:#ccc;transition:all .2s linear}.cq-themes>li>.cq-close:after{-webkit-transform:rotate(45deg);transform:rotate(45deg)}.cq-themes>li>.cq-close:before{-webkit-transform:rotate(-45deg);transform:rotate(-45deg)}.cq-themes>li>.cq-close:hover:after,.cq-themes>li>.cq-close:hover:before{background-color:#555}.cq-themes>li>img{position:absolute;top:0;-webkit-filter:blur(6px) saturate(2);background-size:cover;max-width:100%;height:auto}.cq-themes>li.cq-selected{cursor:default;pointer-events:none}.cq-themes>li.cq-selected>.cq-close{display:none !important}.cq-themes>li.cq-selected:before{position:absolute;top:0;left:0;bottom:0;right:0;content:' ';background-color:rgba(255,255,255,0.3);z-index:1}.cq-themes>li.cq-selected:after{content:'✓';font-size:2em;position:absolute;top:50%;left:50%;margin-top:-1em;margin-left:-0.5em;z-index:2}.js-enable-ibgm{opacity:.6;cursor:default;pointer-events:none;transition:opacity .2s ease-in}#cq-disable-bgm-ckbx:checked~.js-enable-ibgm{opacity:1;cursor:auto;pointer-events:auto}.cq-update-dialog{position:fixed;top:50px;right:10px;padding:8px;color:#8a6d3b;background-color:#fcf8e3;border:1px solid #faebcc;font-size:.9em;max-width:300px;border-radius:4px;word-break:break-all;word-wrap:break-word;box-shadow:0 3px 10px rgba(0,0,0,0.3);z-index:9998}.cq-update-dialog .cq-title{text-align:center;color:#555;font-size:1.1em}.cq-update-dialog .cq-update-actions a{margin-right:20px}",document.head.appendChild(a))},E=document.getElementById("pageContent"),r=document.querySelector(".mod-side-nav-message"),P=document.querySelector(".col-main-sidebar"),u=document.querySelector(".col-main-feed"),y=function(){var a,b;b=E.getBoundingClientRect().top,r.classList[b<=41?"add":"remove"]("cq-fixed-sidebar"),a=b<=-1750?"add":"remove",P.classList[a]("cq-hide"),u.classList[a]("cq-fullwidth")},x=function(a){var b,c;a.metaKey&&13===a.keyCode&&(c=m(a.target,"qz-poster-inner"))&&null!=(b=c.querySelector(".btn-post"))&&b.click()},k=function(){var a;a=R(y),a(),window.addEventListener("scroll",a),~navigator.userAgent.indexOf("OS X")&&E.addEventListener("keydown",function(a){a.target.classList.contains("textarea")&&x(a)},!0)},d=0,f=[],I=function(){M(),L()},M=function(){var a,b;b=[".votestar",".buy-info",".f-single-biz",'[href="http://user.qzone.qq.com/20050606"]'],a=document.querySelectorAll(b.join(",")),Array.prototype.forEach.call(a,N)},L=function(){var a,b;(f=t.getKwds())&&f.length&&(b=[".f-info",".f-ct"],a=document.querySelectorAll(b.join(",")),Array.prototype.forEach.call(a,K))},K=function(a){var b,c;c=a.textContent,(b=f.some(function(a){return~c.indexOf(a)}))&&N(a)},N=function(a){(a=m(a,"f-single"))&&(J(a)&&console.info("%cremove ads(NO."+ ++d+"): %c"+a.textContent,"color:#5d7895","color: #333"),a=null)},j=function(){var a;a=i(I),a(),document.getElementById("main_feed_container").addEventListener("DOMSubtreeModified",a)},Q=function(a){var b,c;c='<div class="cq-update-dialog"> <div class="cq-title">Clean Qzone有更新</div> <div class="cq-version-info">官网版本'+a.version+"，当前使用的版本"+a.oldVersion+'</div> <div class="cq-update-detail"><strong>更新详情</strong>: '+a.updateMsg+' </div> <div class="cq-update-actions"><a href="https://github.com/evecalm/clean-qzone#更新" target="_blank">去更新</a> <a href="javascript:;">知道鸟</a></div>',b=document.createElement("div"),b.innerHTML=c,b=b.firstElementChild,b.addEventListener("click",function(a){"a"===a.target.tagName.toLowerCase()&&b.classList.add("cq-hide")}),document.body.appendChild(b),console.log("show alert infoooooo")},T=function(a){document.documentElement.classList[a?"add":"remove"]("cq-show-setting-dlg"),a&&B()},B=function(){H()},n=function(){var a;return n.wp?n.wp:(a='<div class="cq-settings-dialog">\n  <div class="cq-settings-close"></div>\n  <div class="cq-sidemenu">\n    <div class="title">\n       Clean Qzone\n    </div>\n    <ul class="cq-menus" id="cq-settings-menus">\n      <li class="active" data-target="cq-setting-kwds">屏蔽关键字</li>\n      <li data-target="cq-setting-theme">主题设置</li>\n      <li data-target="cq-setting-others">其他</li>\n    </ul>\n  </div>\n  <div class="cq-setting-wrapper" id="cq-setting-wrapper">\n    <div class="cq-setting-content active" id="cq-setting-kwds">\n      <div class="title">屏蔽关键字 <small>屏蔽含有关键字的动态</small></div>\n      <div class="cq-input-wrapper">\n        <label>添加关键字 <input type="text" class="cq-input" id="cq-kwd-input"></label> <button class="cq-btn" id="cq-kwd-add-btn">添加</button>\n      </div>\n      <ul class="cq-kwds" id="cq-kwds-list">\n      </ul>\n    </div>\n\n    <div class="cq-setting-content" id="cq-setting-theme">\n      <div class="title">主题设置 <small>使用 OS X Yosemite风格主题</small></div>\n      <input type="checkbox" id="cq-theme-ckbx"><label for="cq-theme-ckbx"> 启用 Yosemite 主题, 高大上!</label>\n      <div class="cq-theme-choose-wrapper" id="cq-theme-choose-wrapper">\n        <div class="cq-input-wrapper">\n          选择下列背景图, 或者自定义图片URL\n          <input type="text" class="cq-input" id="cq-themeurl-input"> <button class="cq-btn" id="cq-theme-add-btn">设置</button>\n        </div>\n        <ul class="cq-themes" id="cq-themes-list">\n          <li><img src="http://b.zol-img.com.cn/desk/bizhi/image/6/1440x900/1436338676892.jpg"></li>\n          <li><img src="http://dl.bizhi.sogou.com/images/2014/09/10/869135.jpg"></li>\n          <li><img src="http://dl.bizhi.sogou.com/images/2014/09/15/876900.jpg"></li>\n          <li><img src="http://dl.bizhi.sogou.com/images/2013/11/27/423205.jpg"></li>\n          <li><img src="http://dl.bizhi.sogou.com/images/2013/09/25/389783.jpg"></li>\n          <li><img src="http://dl.bizhi.sogou.com/images/2015/03/31/1131254.jpg"></li>\n          <li><img src="http://dl.bizhi.sogou.com/images/2014/11/28/981054.jpg"></li>\n        </ul>\n      </div>\n    </div>\n    <div id="cq-setting-others" class="cq-setting-content">\n      <div class="title">其他设置 <small><a href="https://github.com/evecalm/clean-qzone/issues/new" target="_blank">有其他功能建议?</a></small></div>\n      \x3c!--\n      <div class="cq-input-wrapper">\n        <input type="checkbox" id="cq-disable-bgm-ckbx">\n        <label for="cq-disable-bgm-ckbx">禁止自动播放背景音乐</label>\n        <label class="cq-label js-enable-ibgm">\n          <input type="checkbox" id="cq-enable-ibgm-ckbx"> 只允许我的空间自动播放背景音乐\n        </label>\n      </div>\n      --\x3e\n      <div class="cq-input-wrapper">\n        <label><input type="checkbox" id="cq-disable-qvip-ckbx"> 移除所有黄钻相关的logo/菜单/推广</label>\n      </div>\n    </div>\n  </div>\n</div>',n.wp=document.createElement("div"),n.wp.classList.add("cq-overlay"),n.wp.innerHTML=a,document.body.appendChild(n.wp),n.wp)},e=function(){return document.getElementById("cq-settings-menus").addEventListener("click",z),document.getElementById("cq-kwd-add-btn").addEventListener("click",v),document.getElementById("cq-kwds-list").addEventListener("click",A),document.getElementById("cq-theme-ckbx").addEventListener("change",C),document.getElementById("cq-theme-add-btn").addEventListener("click",w),document.getElementById("cq-themes-list").addEventListener("click",D),document.querySelector(".cq-settings-close").addEventListener("click",function(){return T()}),document.addEventListener("keydown",function(a){27===a.keyCode&&"input"!==a.target.tagName.toLowerCase()&&document.documentElement.classList.contains("cq-show-setting-dlg")&&(T(),a.stopPropagation())},!0),document.getElementById("cq-kwd-input").addEventListener("keydown",function(a){if(27===a.keyCode)return void a.stopPropagation();13===a.keyCode&&document.getElementById("cq-kwd-add-btn").click()}),document.getElementById("cq-themeurl-input").addEventListener("keydown",function(a){if(27===a.keyCode)return void a.stopPropagation();13===a.keyCode&&document.getElementById("cq-theme-add-btn").click()}),document.getElementById("cq-disable-qvip-ckbx").addEventListener("change",function(){S(this.checked)})},z=function(a){var b,c,d;b=a.target,"li"===b.tagName.toLowerCase()&&(b.classList.contains("active")||(c=this.querySelector(".active"),c&&c.classList.remove("active"),b.classList.add("active"),(d=b.getAttribute("data-target"))&&(c=document.getElementById("cq-setting-wrapper").querySelector(".cq-setting-content.active"),c&&c.classList.remove("active"),(b=document.getElementById(d))&&b.classList.add("active"))))},v=function(a){var b,c;b=document.getElementById("cq-kwd-input"),(c=b.value.trim())&&(t.addKwd(c)?(F(c),b.value=""):console.log("关键字已存在"))},F=function(a){var b,c;b=document.createElement("li"),b.innerHTML=l(a)+"<span class='close'></span>",c=document.getElementById("cq-kwds-list"),c.insertBefore(b,c.firstElementChild)},A=function(a){var b,c,d;d=a.target,"span"===d.tagName.toLowerCase()&&d.classList.contains("close")&&(c=d.parentElement,b=c.textContent.trim(),t.removeKwd(b),J(c))},H=function(){var a,b;b=t.getKwds(),a=b.reduce(function(a,b){return a+"<li>"+l(b)+"<span class='close'></span></li>"},""),document.getElementById("cq-kwds-list").innerHTML=a},C=function(){var a;a=this.checked,U(a),a&&O()},U=function(a){a=!!a,document.documentElement.classList[a?"add":"remove"]("cq-yosemite"),t.set("yosemite-theme",a)},O=function(){var a,b;b=document.getElementById("cq-themes-list"),(a=b.querySelector(".cq-selected")||b.firstElementChild)&&(a.classList.add("cq-selected"),V(a.querySelector("img").src))},s=function(a,b,c){var d;d=new Image,b&&(d.onload=b),c&&(d.onerror=c),d.src=a},w=function(){var a;(a=document.getElementById("cq-themeurl-input").value)&&s(a,function(){return G(a)})},G=function(a){var b,c;t.addBgimg(a)&&(document.getElementById("cq-themeurl-input").value="",b=document.createElement("li"),b.innerHTML='<span class="cq-close"></span><img src="'+a+'">',c=document.getElementById("cq-themes-list"),c.insertBefore(b,c.firstElementChild),b.querySelector("img").click())},p=function(){var a,b,c,d,e;b=t.getBgimgs(),c=document.createDocumentFragment(),b.forEach(function(a){var b;b=document.createElement("li"),b.innerHTML='<span class="cq-close"></span><img src="'+a+'">',c.appendChild(b)}),e=document.getElementById("cq-themes-list"),e.insertBefore(c,e.firstElementChild),(a=t.get("bgimg"))&&(d=e.querySelector('[src="'+a+'"]'))&&d.parentElement.classList.add("cq-selected")},D=function(a){var b,c,d;if(c=a.target,b=c.parentElement,"img"===c.tagName.toLowerCase()){if(b.classList.contains("cq-selected"))return;null!=(d=this.querySelector(".cq-selected"))&&d.classList.remove("cq-selected"),b.classList.add("cq-selected"),V(c.src)}else c.classList.contains("cq-close")&&(t.removeBgimg(b.querySelector("img").src),J(b))},V=function(a){V.wp&&a||(V.wp=document.createElement("div"),V.wp.classList.add("cq-bg"),document.body.insertBefore(V.wp,document.body.firstElementChild)),V.wp.style.backgroundImage="url("+a+")",t.set("bgimg",a)},c=function(){var a,b;(b=document.querySelector("#tb_setting_panel .drop-down-setting"))&&(a=document.createElement("a"),a.href="javascript:;",a.textContent="Clean Qzone",a.addEventListener("click",function(){T(!0)}),b.insertBefore(a,b.firstElementChild))},S=function(a){a=!!a,document.documentElement.classList[a?"add":"remove"]("cq-remove-qzvip"),t.set("disable-all-vip-logo",a)},o=function(){var a,b;n(),c(),e(),p(),t.get("disable-all-vip-logo")&&(S(!0),document.getElementById("cq-disable-qvip-ckbx").checked=!0),(b=t.get("yosemite-theme"))&&(a=t.get("bgimg"))&&(document.getElementById("cq-theme-ckbx").checked=!0,U(b),V(a))},b="0.1.12",h=function(a){var c,d;for(d=b.split("."),a=a.split("."),c=0;c<3;){if(+d[c]<+a[c])return!0;++c}return!1},a.checkCqUpdate=function(a){h(a.version)&&a.version!==t.get("version")&&(a.oldVersion=b,Q(a),t.set("version",a.version))},g=function(){var a;a=document.createElement("script"),a.src="http://app.evecalm.com/clean-qzone/dist/clean-qzone.check-update.js",document.body.appendChild(a)},function(){q(),document.querySelector(".mod-side-nav-message")&&(j(),k(),g(),o())}()}proxy(main);